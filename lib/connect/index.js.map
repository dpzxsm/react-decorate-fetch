{"version":3,"sources":["../../src/connect/index.js"],"names":["mapRequestToProps","defaults","options","mapRequest","Object","assign","withRef","WrappedComponent","ConnectComponent","props","context","mappings","lazyRequest","requests","responses","keys","forEach","key","Function","prototype","isPrototypeOf","params","childMappings","childRequests","map","request","initialResponsesState","finalResponses","Promise","all","item","then","response","results","setState","pre","length","status","loading","push","newResponses","state","refactorMapRequestToState","prevProps","newState","nextProps","error","ref","Component"],"mappings":"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","sourcesContent":["import React, { Component } from 'react';\nimport hoistStatics from 'hoist-non-react-statics';\nimport { omitChildren } from '../utils/helper';\nimport isPlainObject from \"../utils/isPlainObject\";\nimport shallowEqual from \"../utils/shallowEqual\";\nimport { mapRequestByOptions } from \"../utils/mapRequest\";\n\nexport default function (mapRequestToProps, defaults, options) {\n  mapRequestToProps = mapRequestToProps || (() => ({}));\n  if (isPlainObject(mapRequestToProps)) {\n    let mapRequest = Object.assign({}, mapRequestToProps);\n    mapRequestToProps = () => mapRequest;\n  }\n  options = Object.assign({ withRef: false }, options);\n  return function (WrappedComponent) {\n    class ConnectComponent extends Component {\n      constructor(props, context) {\n        super(props, context);\n        // 初始化request\n        this.state = this.refactorMapRequestToState(mapRequestToProps(omitChildren(props)));\n      }\n\n      refactorMapRequestToState = (mappings) => {\n        let lazyRequest = [];\n        let requests = {};\n        let responses = {};\n        Object.keys(mappings).forEach((key) => {\n          let options = mappings[key];\n          if (Function.prototype.isPrototypeOf(options)) {\n            requests[key] = (params) => {\n              let childMappings = options(params);\n              let childRequests = Object.keys(childMappings).map(key => {\n                let request = mapRequestByOptions(childMappings[key], defaults);\n                return ({\n                  key,\n                  request\n                });\n              });\n              this.initialResponsesState(childRequests);\n              let finalResponses = {};\n              return Promise.all(childRequests.map(item => {\n                return item.request().then(response => {\n                  finalResponses[item.key] = response;\n                  return response;\n                });\n              })).then((results) => {\n                this.setState((pre) => ({\n                  responses: {\n                    ...pre.responses, ...finalResponses\n                  }\n                }));\n                if (results.length > 0) {\n                  return results;\n                } else {\n                  return results[0];\n                }\n              });\n            };\n          } else {\n            responses[key] = {\n              status: 'pending',\n              loading: false\n            };\n            lazyRequest.push({\n              key,\n              request: mapRequestByOptions(options, defaults)\n            });\n          }\n        });\n        return {\n          lazyRequest,\n          requests,\n          responses\n        };\n      };\n\n      initialResponsesState = (requests = []) => {\n        if (requests.length === 0) return;\n        this.setState((pre) => {\n          let newResponses = {};\n          requests.forEach((item) => {\n            if (item.key) {\n              newResponses[item.key] = {\n                status: 'loading',\n                loading: true\n              };\n            }\n          });\n          return {\n            responses: {\n              ...pre.responses, ...newResponses\n            }\n          };\n        });\n      };\n\n      componentDidUpdate(prevProps) {\n        if (!shallowEqual(prevProps, this.props)) {\n          // 因为props发生了变化，所以更新requests\n          let newState = this.refactorMapRequestToState(mapRequestToProps(omitChildren(nextProps)));\n          this.setState({\n            requests: newState.requests\n          });\n        }\n      }\n\n      componentDidMount() {\n        let { lazyRequest, responses } = this.state;\n        // 没有懒加载的话，就返回，防止不必要的渲染\n        if (lazyRequest.length === 0) return;\n        let finalResponses = Object.assign({}, responses);\n        // 设置成功和失败\n        Promise.all(lazyRequest.map(item => {\n          return item.request().then((response) => {\n            finalResponses[item.key] = response;\n          }).catch((error) => {\n            finalResponses[item.key] = error;\n          });\n        })).then(() => {\n          this.setState({\n            responses: finalResponses\n          });\n        }).catch(() => {\n          this.setState({\n            responses: finalResponses\n          });\n        });\n      }\n\n      render() {\n        const ref = options.withRef ? 'wrappedInstance' : null;\n        return <WrappedComponent\n          {...this.state.responses}\n          {...this.state.requests}\n          {...this.props}\n          ref={ref}\n        />;\n      }\n    }\n\n    return hoistStatics(ConnectComponent, WrappedComponent);\n  };\n}\n"],"file":"index.js"}