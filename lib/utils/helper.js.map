{"version":3,"sources":["../../src/utils/helper.js"],"names":["defaults","fetchOptions","method","headers","delay","successText","cleanParams","buildResponse","res","json","then","dataOrError","ok","fetch","getTopFetch","fetchInitKeys","omitChildren","obj","children","rest","buildQuery","params","esc","encodeURIComponent","Object","keys","map","k","Array","isArray","key","items","item","join","filterOptions","options","reduce","data","indexOf","topFetch","window","bind","global","self","buildFetch","url","finalOptions","assign","host","match","forEach","undefined","controller","AbortController","signal","query","body","transformPostParams","postForm","formData","FormData","append","JSON","stringify","promise","cancel","abort","initConfig","Function","prototype","isPrototypeOf","console","log","FetchError","error","message","code"],"mappings":"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","sourcesContent":["const defaults = {\n  fetchOptions: {\n    method: 'GET',\n    headers: {\n      'Accept': 'application/json',\n      'Content-Type': 'application/json'\n    },\n    delay: 0,\n    successText: 'Success',\n    cleanParams: true\n  },\n  buildResponse: function (res) {\n    if (res && res.json) {\n      return res.json().then((dataOrError) => {\n        if (res.ok) {\n          return dataOrError;\n        } else {\n          throw dataOrError;\n        }\n      });\n    } else {\n      return {};\n    }\n  },\n  fetch: getTopFetch()\n};\n\nconst fetchInitKeys = ['method', 'headers', 'body', 'mode', 'credentials', 'cache', 'redirect', 'referrer', 'referrerPolicy', 'integrity', 'signal'];\n\nfunction omitChildren(obj) {\n  const { children, ...rest } = obj;\n  return rest;\n}\n\nfunction buildQuery(params) {\n  let esc = encodeURIComponent;\n  return Object.keys(params)\n    .map(k => {\n      if (Array.isArray(params[k])) {\n        let key = k;\n        let items = params[k].map(item => {\n          return esc(key + '[]') + '=' + esc(item);\n        });\n        return items.join('&');\n      } else {\n        return esc(k) + '=' + esc(params[k]);\n      }\n    })\n    .join('&');\n}\n\nfunction filterOptions(options) {\n  return Object.keys(options).reduce((data, key) => {\n    if (fetchInitKeys.indexOf(key) !== -1) {\n      data[key] = options[key];\n    }\n    return data;\n  }, {});\n}\n\nfunction getTopFetch() {\n  let topFetch;\n  if (typeof window !== 'undefined') {\n    if (window.fetch) {\n      topFetch = window.fetch.bind(window);\n    }\n  } else if (typeof global !== 'undefined') {\n    if (global.fetch) {\n      topFetch = global.fetch.bind(global);\n    }\n  } else if (typeof self !== 'undefined') {\n    if (self.fetch) {\n      topFetch = self.fetch.bind(self);\n    }\n  }\n  return topFetch;\n}\n\nfunction buildFetch(url, options = {}) {\n  let { params = {}, ...finalOptions } = options;\n  // merge params\n  params = Object.assign({}, defaults.fetchOptions.params, params);\n  // merge special options\n  finalOptions.headers = Object.assign({}, defaults.fetchOptions.headers, finalOptions.headers);\n  // merge options\n  finalOptions = Object.assign({}, defaults.fetchOptions, finalOptions);\n\n  let host = finalOptions.host;\n  if (!url.match(/https?:\\/\\//) && host) {\n    url = host + url;\n  }\n\n  // clean params, like null, undefined\n  if (finalOptions.cleanParams) {\n    Object.keys(params).forEach(key => {\n      if (params[key] === undefined || params[key] === null) {\n        delete params[key];\n      }\n    })\n  }\n\n  // set signal\n  let controller;\n  if (window.AbortController && !finalOptions.signal) {\n    controller = new window.AbortController();\n    finalOptions.signal = controller.signal;\n  }\n\n  if (finalOptions.method === 'GET') {\n    let query = buildQuery(params);\n    if (query) {\n      if (url.match(/https?:\\/\\/.*\\?/)) {\n        url = url + '&' + buildQuery(params);\n      } else {\n        url = url + '?' + buildQuery(params);\n      }\n    }\n  } else if (finalOptions.method === 'POST' && !finalOptions.body) {\n    let transformPostParams = defaults.transformPostParams;\n    if (transformPostParams) {\n      finalOptions.body = transformPostParams(params, finalOptions);\n    } else {\n      if (finalOptions.postForm) {\n        let formData = new FormData();\n        Object.keys(params).forEach(key => {\n          formData.append(key, params[key]);\n        });\n        finalOptions.body = formData;\n      } else {\n        finalOptions.body = JSON.stringify(params);\n      }\n    }\n  }\n  // 筛选最终的fetch参数\n  finalOptions = filterOptions(finalOptions);\n  let topFetch = defaults.fetch || getTopFetch();\n  return {\n    promise: topFetch(url, finalOptions).then((res) => {\n      return defaults.buildResponse(res);\n    }),\n    cancel: () => controller && controller.abort()\n  }\n}\n\nfunction initConfig({ fetchOptions = {}, buildResponse, transformPostParams, fetch }) {\n  if (typeof fetchOptions === 'object') {\n    defaults.fetchOptions = Object.assign(defaults.fetchOptions, fetchOptions);\n  }\n  if (Function.prototype.isPrototypeOf(buildResponse)) {\n    defaults.buildResponse = buildResponse;\n  }\n  if (Function.prototype.isPrototypeOf(transformPostParams)) {\n    defaults.transformPostParams = transformPostParams;\n  }\n  if (fetch) {\n    console.log('global fetch api is change');\n    defaults.fetch = fetch;\n  }\n}\n\nclass FetchError {\n  constructor(error) {\n    if (typeof error === 'string') {\n      this.message = error;\n      this.code = 0;\n    } else {\n      this.message = error.message;\n      this.code = error.code || 0;\n    }\n  }\n\n  toString() {\n    return this.message;\n  }\n}\n\nexport {\n  defaults,\n  FetchError,\n  omitChildren,\n  buildFetch,\n  initConfig\n};\n"],"file":"helper.js"}