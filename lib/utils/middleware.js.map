{"version":3,"sources":["../../src/utils/middleware.js"],"names":["middlewares","applyMiddleware","plugin","Object","keys","forEach","key","FetchError","push","removeMiddleware","index","indexOf","splice","defaultNext","context","next","compose","action","dispatch","i","Promise","reject","Error","fn","undefined","length","resolve","bind","err"],"mappings":";;;;;;;;;;AAAA;;AAEA,IAAMA,WAAW,GAAG,EAApB;AAEA;;;;AAGO,SAASC,eAAT,CAAyBC,MAAzB,EAAiC;AACtC;AACAC,EAAAA,MAAM,CAACC,IAAP,CAAYF,MAAZ,EAAoBG,OAApB,CAA4B,UAACC,GAAD,EAAS;AACnC,QAAI,OAAOJ,MAAM,CAACI,GAAD,CAAb,KAAuB,UAA3B,EAAuC;AACrC,YAAM,IAAIC,kBAAJ,CAAe,2CAAf,CAAN;AACD;AACF,GAJD;AAKAP,EAAAA,WAAW,CAACQ,IAAZ,CAAiBN,MAAjB;AACD;;AAEM,SAASO,gBAAT,CAA0BP,MAA1B,EAAkC;AACvC,MAAIQ,KAAK,GAAGV,WAAW,CAACW,OAAZ,CAAoBT,MAApB,CAAZ;;AACA,MAAIQ,KAAK,KAAK,CAAC,CAAf,EAAkB;AAChBV,IAAAA,WAAW,CAACY,MAAZ,CAAmBF,KAAnB,EAA0B,CAA1B;AACD;AACF;;AAED,IAAMG,WAAW,GAAG,SAAdA,WAAc,CAAUC,OAAV,EAAmBC,IAAnB,EAAyB;AAC3C;AACAA,EAAAA,IAAI;AACL,CAHD;;AAKO,SAASC,OAAT,CAAiBC,MAAjB,EAAyB;AAC9B,SAAO,UAAUH,OAAV,EAAmBC,IAAnB,EAAyB;AAC9B;AACA,QAAIL,KAAK,GAAG,CAAC,CAAb;AACA,WAAOQ,QAAQ,CAAC,CAAD,CAAf;;AAEA,aAASA,QAAT,CAAkBC,CAAlB,EAAqB;AACnB,UAAIA,CAAC,IAAIT,KAAT,EAAgB,OAAOU,OAAO,CAACC,MAAR,CAAe,IAAIC,KAAJ,CAAU,8BAAV,CAAf,CAAP;AAChBZ,MAAAA,KAAK,GAAGS,CAAR;AACA,UAAII,EAAE,GAAGvB,WAAW,CAACmB,CAAD,CAAX,GAAkBnB,WAAW,CAACmB,CAAD,CAAX,CAAeF,MAAf,KAA0BJ,WAA5C,GAA2DW,SAApE;AACA,UAAIL,CAAC,KAAKnB,WAAW,CAACyB,MAAtB,EAA8BF,EAAE,GAAGR,IAAL;AAC9B,UAAI,CAACQ,EAAL,EAAS,OAAOH,OAAO,CAACM,OAAR,EAAP;;AACT,UAAI;AACF,eAAON,OAAO,CAACM,OAAR,CAAgBH,EAAE,CAACT,OAAD,EAAUI,QAAQ,CAACS,IAAT,CAAc,IAAd,EAAoBR,CAAC,GAAG,CAAxB,CAAV,CAAlB,CAAP;AACD,OAFD,CAEE,OAAOS,GAAP,EAAY;AACZ,eAAOR,OAAO,CAACC,MAAR,CAAeO,GAAf,CAAP;AACD;AACF;AACF,GAjBD;AAkBD;;eAEc5B,W","sourcesContent":["import { FetchError } from \"./helper\";\n\nconst middlewares = [];\n\n/**\n * 添加中间件\n */\nexport function applyMiddleware(plugin) {\n  // check middlewares\n  Object.keys(plugin).forEach((key) => {\n    if (typeof plugin[key] !== \"function\") {\n      throw new FetchError(\"The Middleware's action must be function!\");\n    }\n  });\n  middlewares.push(plugin);\n}\n\nexport function removeMiddleware(plugin) {\n  let index = middlewares.indexOf(plugin);\n  if (index !== -1) {\n    middlewares.splice(index, 1);\n  }\n}\n\nconst defaultNext = function (context, next) {\n  // do nothing\n  next();\n};\n\nexport function compose(action) {\n  return function (context, next) {\n    // last called middleware #\n    let index = -1;\n    return dispatch(0);\n\n    function dispatch(i) {\n      if (i <= index) return Promise.reject(new Error('next() called multiple times'));\n      index = i;\n      let fn = middlewares[i] ? (middlewares[i][action] || defaultNext) : undefined;\n      if (i === middlewares.length) fn = next;\n      if (!fn) return Promise.resolve();\n      try {\n        return Promise.resolve(fn(context, dispatch.bind(null, i + 1)));\n      } catch (err) {\n        return Promise.reject(err);\n      }\n    }\n  };\n}\n\nexport default middlewares;\n"],"file":"middleware.js"}